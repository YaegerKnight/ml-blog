<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Using the seven-step SGD process for Fashion MNIST | mlops.systems</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Using the seven-step SGD process for Fashion MNIST" />
<meta name="author" content="Alex Strick van Linschoten" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I apply all the lessons we’ve learned so far on the Fashion MNIST dataset. This requires us learning a few new concepts like optimisers, ReLU, nonlinearity and so on." />
<meta property="og:description" content="I apply all the lessons we’ve learned so far on the Fashion MNIST dataset. This requires us learning a few new concepts like optimisers, ReLU, nonlinearity and so on." />
<link rel="canonical" href="https://mlops.systems/fastai/computervision/pytorch/2022/05/14/SGD-fashion-mnist.html" />
<meta property="og:url" content="https://mlops.systems/fastai/computervision/pytorch/2022/05/14/SGD-fashion-mnist.html" />
<meta property="og:site_name" content="mlops.systems" />
<meta property="og:image" content="https://mlops.systems/images/fashion-mnist/fashion-mnist-small.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-14T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2022-05-14T00:00:00-05:00","url":"https://mlops.systems/fastai/computervision/pytorch/2022/05/14/SGD-fashion-mnist.html","@type":"BlogPosting","dateModified":"2022-05-14T00:00:00-05:00","image":"https://mlops.systems/images/fashion-mnist/fashion-mnist-small.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlops.systems/fastai/computervision/pytorch/2022/05/14/SGD-fashion-mnist.html"},"author":{"@type":"Person","name":"Alex Strick van Linschoten"},"headline":"Using the seven-step SGD process for Fashion MNIST","description":"I apply all the lessons we’ve learned so far on the Fashion MNIST dataset. This requires us learning a few new concepts like optimisers, ReLU, nonlinearity and so on.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://mlops.systems/feed.xml" title="mlops.systems" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script
  defer
  data-domain="mlops.systems"
  src="https://plausible.io/js/plausible.js"
></script>


<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">mlops.systems</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Using the seven-step SGD process for Fashion MNIST</h1><p class="page-description">I apply all the lessons we've learned so far on the Fashion MNIST dataset. This requires us learning a few new concepts like optimisers, ReLU, nonlinearity and so on.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-05-14T00:00:00-05:00" itemprop="datePublished">
        May 14, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Alex Strick van Linschoten</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      9 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#fastai">fastai</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#computervision">computervision</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#pytorch">pytorch</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/strickvl/ml-blog/tree/master/_notebooks/2022-05-14-SGD-fashion-mnist.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/strickvl/ml-blog/master?filepath=_notebooks%2F2022-05-14-SGD-fashion-mnist.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/strickvl/ml-blog/blob/master/_notebooks/2022-05-14-SGD-fashion-mnist.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#Getting-our-data-into-the-right-format">Getting our data into the right format </a></li>
<li class="toc-entry toc-h1"><a href="#Initialising-our-weights-and-bias">Initialising our weights and bias </a></li>
<li class="toc-entry toc-h1"><a href="#Matrix-multiplication-to-calculate-our-predictions">Matrix multiplication to calculate our predictions </a></li>
<li class="toc-entry toc-h1"><a href="#A-loss-function-to-evaluate-model-performance">A loss function to evaluate model performance </a></li>
<li class="toc-entry toc-h1"><a href="#DataLoaders-and-Datasets">DataLoaders and Datasets </a></li>
<li class="toc-entry toc-h1"><a href="#Training-our-model">Training our model </a></li>
<li class="toc-entry toc-h1"><a href="#Optimising-with-an-Optimiser">Optimising with an Optimiser </a></li>
<li class="toc-entry toc-h1"><a href="#Some-extra-fastai-abstractions">Some extra fastai abstractions </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-05-14-SGD-fashion-mnist.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install -Uqq fastbook nbdev torch
<span class="kn">import</span> <span class="nn">fastbook</span>
<span class="n">fastbook</span><span class="o">.</span><span class="n">setup_book</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastbook</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">ToTensor</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In <a href="https://mlops.systems/fastai/computervision/pytorch/2022/05/13/sgd-whole-game.html">the previous
post</a>
I used the seven-step process to fit to an unknown function. The process as a
whole is fairly simple to get your head around, but there are a good few details
to keep track of along the way. This will continue to be the case as we get into
this walkthrough of how to do the same for the Fashion MNIST pullover vs dress data.</p>
<h1 id="Getting-our-data-into-the-right-format">
<a class="anchor" href="#Getting-our-data-into-the-right-format" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting our data into the right format<a class="anchor-link" href="#Getting-our-data-into-the-right-format"> </a>
</h1>
<p>The first thing we need to handle is making sure our data is in the right
format, shape and so on. We begin by downloading our data and splitting the data
into training and test sets.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">training_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="s2">"data"</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ToTensor</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">test_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="s2">"data"</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ToTensor</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">training_dresses</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">training_data</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">training_pullovers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">training_data</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">test_dresses</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">test_data</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">test_pullovers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">test_data</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>

<span class="n">training_dresses_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">training_dresses</span><span class="p">)</span>
<span class="n">training_pullovers_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">training_pullovers</span><span class="p">)</span>
<span class="n">test_dresses_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">test_dresses</span><span class="p">)</span>
<span class="n">test_pullovers_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">test_pullovers</span><span class="p">)</span>

<span class="n">training_dresses_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">test_dresses_tensor</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([6000, 28, 28]), torch.Size([1000, 28, 28]))</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">training_dresses_tensor</span><span class="p">,</span> <span class="n">training_pullovers_tensor</span><span class="p">])</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span>
<span class="n">train_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">training_dresses</span><span class="p">)),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">training_pullovers</span><span class="p">))])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">valid_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">test_dresses_tensor</span><span class="p">,</span> <span class="n">test_pullovers_tensor</span><span class="p">])</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span>
<span class="n">valid_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_dresses</span><span class="p">)),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_pullovers</span><span class="p">))])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">train_y</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([12000, 784]), torch.Size([12000, 1]))</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We transform our images tensors from matrices into vectors with all the values
one after another. We create a <code>train_y</code> vector with our labels which we can use
to check how well we did with our predictions.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We create datasets out of our tensors. This means that we can feed our data into
our training functions in the way that is most convenient (i.e. an image is
paired with the correct label).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_dset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">))</span>
<span class="n">valid_dset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">valid_x</span><span class="p">,</span> <span class="n">valid_y</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Initialising-our-weights-and-bias">
<a class="anchor" href="#Initialising-our-weights-and-bias" aria-hidden="true"><span class="octicon octicon-link"></span></a>Initialising our weights and bias<a class="anchor-link" href="#Initialising-our-weights-and-bias"> </a>
</h1>
<p>As in the previous times where we've done this, we initialise our parameters or
weights with random values. This means that for every pixel represented in the
images, we'll start off with purely random values. We initialise our bias to a
random number as well.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">initialise_params</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">()</span>

<span class="n">weights</span> <span class="o">=</span> <span class="n">initialise_params</span><span class="p">((</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">initialise_params</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">(</span><span class="n">train_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">bias</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([2.8681], grad_fn=&lt;AddBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Matrix-multiplication-to-calculate-our-predictions">
<a class="anchor" href="#Matrix-multiplication-to-calculate-our-predictions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Matrix multiplication to calculate our predictions<a class="anchor-link" href="#Matrix-multiplication-to-calculate-our-predictions"> </a>
</h1>
<p>We'll need to make many calculations like the one we just made, and luckily the
technique of matrix multiplication helps us with exactly the scenario we have:
we want to multiply the values of our image (laid out in a single vector) with
the weights and to add the bias.</p>
<p>In Python, matrix multiplication is carried out with a simple <code>@</code> operator, so
we can bring all of this together as a function:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">linear1</span><span class="p">(</span><span class="n">x_batch</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x_batch</span><span class="nd">@weights</span> <span class="o">+</span> <span class="n">bias</span>

<span class="n">preds</span> <span class="o">=</span> <span class="n">linear1</span><span class="p">(</span><span class="n">train_x</span><span class="p">)</span>
<span class="n">preds</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([[  2.8681],
        [ -7.6810],
        [-17.5719],
        ...,
        [ -3.8665],
        [  2.0646],
        [ -2.5148]], grad_fn=&lt;AddBackward0&gt;)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can check our accuracy for these predictions:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">corrects</span> <span class="o">=</span> <span class="p">(</span><span class="n">preds</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">==</span> <span class="n">train_y</span>
<span class="n">corrects</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.35324999690055847</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our accuracy is pretty poor! A lot worse than even 50/50 luck which is what
you'd expect to get on average from a random set of initial weights. Apparently
we had a bad draw of luck this time round!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="A-loss-function-to-evaluate-model-performance">
<a class="anchor" href="#A-loss-function-to-evaluate-model-performance" aria-hidden="true"><span class="octicon octicon-link"></span></a>A loss function to evaluate model performance<a class="anchor-link" href="#A-loss-function-to-evaluate-model-performance"> </a>
</h1>
<p>We now need a loss function which will tell us how well we are doing in our
predictions, and that can be used as part of the gradient calculations to let us
know (as we iterate) how to update our weights.</p>
<p>The problem, especially in the data set we're working with, is that we have a
binary probability: either it's a dress or a pullover. Zero or one. Unlike in a
regression problem, or something similar, we don't have any smooth selection of
contiguous values that get predicted. We have zero or one.</p>
<p>At this point we learn about the sigmoid function which is a way to reframe this
problem in a way that we can use to our advantage. The sigmoid function when
plotted looks like this:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>

<span class="n">plot_function</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Sigmoid"</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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">
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This function, as you can see, takes any input value and squashes it down such
that the output value is between 0 and 1. It also has a smooth curve, all headed
in the same direction, between those values. This is ideal for our situation.
The first thing we must do as part of our loss function, therefore, is to apply
the sigmoid function to the inputs.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">fashion_mnist_loss</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">targets</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This <code>torch.where(...)</code> function is a handy way of iterating through all our
data, checking whether our target is 1 or not, then outputting the distance from
the correct prediction and calculating the mean of these predictions across the
entire dataset.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="DataLoaders-and-Datasets">
<a class="anchor" href="#DataLoaders-and-Datasets" aria-hidden="true"><span class="octicon octicon-link"></span></a>DataLoaders and Datasets<a class="anchor-link" href="#DataLoaders-and-Datasets"> </a>
</h1>
<p>We've already created datasets for our training and validation data. The process
of iterating through our data, however, requires some thought as to how we'll do
it. Our options:</p>
<ul>
<li>we could iterate through the entire dataset, making the relevant loss and
gradient calculations and adjusting the weights but this might make the
process quite long, even though we'd benefit from the increased accuracy this
would bring since we'd be seeing the entire dataset each iteration.</li>
<li>we could do our calculations after just seeing a single image, but then our
model would be over-influenced and perturbed by the fluctuations from image to
image. This also wouldn't be what we want.</li>
</ul>
<p>In practice, we'll need to choose something in between. This is where
mini-batches or just 'batches' come in. These will be need to be large enough
(and randomly populated!) that our model can meaningfully learn from them, but
not so large that our process takes too long.</p>
<p>Luckily, we have the abstraction of the <code>DataLoader</code> which will create all our
randomly assigned batches for us.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">valid_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">valid_dset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Training-our-model">
<a class="anchor" href="#Training-our-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Training our model<a class="anchor-link" href="#Training-our-model"> </a>
</h1>
<p>Now we can bring the whole process together and train our model:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="n">initialise_params</span><span class="p">((</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">initialise_params</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calculate_gradient</span><span class="p">(</span><span class="n">x_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x_batch</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">fashion_mnist_loss</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="c1"># iterate over the training data, batch by batch</span>
    <span class="k">for</span> <span class="n">x_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="ow">in</span> <span class="n">train_dl</span><span class="p">:</span>
        <span class="c1"># calculate the gradients</span>
        <span class="n">calculate_gradient</span><span class="p">(</span><span class="n">x_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">param</span><span class="o">.</span><span class="n">data</span> <span class="o">-=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="o">*</span> <span class="n">learning_rate</span>
            <span class="c1"># set the gradients to zero</span>
            <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">batch_accuracy</span><span class="p">(</span><span class="n">x_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">):</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">x_batch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">preds</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">==</span> <span class="n">y_batch</span>
    <span class="k">return</span> <span class="n">correct</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">validate_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">accs</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch_accuracy</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">x_batch</span><span class="p">),</span> <span class="n">y_batch</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="ow">in</span> <span class="n">valid_dl</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">accs</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">validate_epoch</span><span class="p">(</span><span class="n">linear1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0.2173</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We start there, but now we can train and watch our accuracy improving:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">weights</span><span class="p">,</span> <span class="n">bias</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">train_epoch</span><span class="p">(</span><span class="n">linear1</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">validate_epoch</span><span class="p">(</span><span class="n">linear1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">" "</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0.5001 0.5016 0.7994 0.9357 0.9481 0.9523 0.9537 0.9555 0.9572 0.9582 0.9578 0.9604 0.9608 0.9609 0.962 0.9611 0.9622 0.9626 0.9631 0.9625 0.963 0.963 0.9633 0.9638 0.964 0.9631 0.9638 0.9638 0.9643 0.9645 </pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We had 91% accuracy on our validation dataset <a href="https://mlops.systems/fastai/computervision/pytorch/2022/05/11/fashion-mnist-pixel-similarity.html#Using-broadcasting-to-check-our-predictions-on-our-validation-data">last time we tried
this</a>
with pixel similarity.</p>
<p>After 30 epochs of training with our new process we've achieved 96%, but we
could still do better! We'll tackle that in the next post.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Optimising-with-an-Optimiser">
<a class="anchor" href="#Optimising-with-an-Optimiser" aria-hidden="true"><span class="octicon octicon-link"></span></a>Optimising with an Optimiser<a class="anchor-link" href="#Optimising-with-an-Optimiser"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Everything that we've been doing so far is so common that there is pre-built
functionality to handle all of the pieces.</p>
<ul>
<li>our <code>linear1</code> function (which calculated predictions based on our weights and
biases) can be replaced with PyTorch's <code>nn.Linear</code> module. Actually,
<code>nn.Linear</code> does the same thing as our <code>initialise_params</code> and our <code>linear1</code>
function combined.</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">linear_model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our PyTorch module carries an internal representation of our weights and our biases:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">weights</span><span class="p">,</span> <span class="n">bias</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>
<span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">bias</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([1, 784]), torch.Size([1]))</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>an optimiser bundles the step functionality and the <code>zero_grad_</code>
functionality. In the book we see how to create our own very basic optimiser,
but <code>fastai</code> provides the basic <code>SGD</code> class which we can use that handles
these same behaviours.</li>
</ul>
<p>We'll need to amend our training function a little to take this into account:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">linear_model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">linear_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">learning_rate</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="ow">in</span> <span class="n">train_dl</span><span class="p">:</span>
        <span class="n">calculate_gradient</span><span class="p">(</span><span class="n">x_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
        <span class="n">train_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">validate_epoch</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">" "</span><span class="p">)</span>

<span class="n">train_model</span><span class="p">(</span><span class="n">linear_model</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0.96 0.9642 0.966 0.9659 0.9663 0.9672 0.9677 0.9668 0.9678 0.9684 0.9681 0.9674 0.9681 0.9671 0.9678 0.9677 0.9684 0.968 0.9687 0.9677 0.9681 0.968 0.9693 0.9684 0.968 0.9686 0.9688 0.9693 0.9698 0.9697 </pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Some-extra-fastai-abstractions">
<a class="anchor" href="#Some-extra-fastai-abstractions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Some extra <code>fastai</code> abstractions<a class="anchor-link" href="#Some-extra-fastai-abstractions"> </a>
</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>fastai</code> handles so much of this for us all, such that the <code>Learner</code> is actually
the thing we can use to get all of the above logic built in.</p>
<p>The <code>Learner</code> takes all of the pieces that we've spent the last few blogs
creating:</p>
<ul>
<li>the <code>DataLoaders</code> (iterators providing the data in batches, in the right
format with paired <code>x</code> and <code>y</code> values)</li>
<li>the model itself (our function that we're trying to optimise)</li>
<li>the optimisation function (which receives our weights and bias parameters as
well as the learning rate)</li>
<li>the loss function</li>
<li>any optional metrics we want printed</li>
</ul>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">DataLoaders</span><span class="p">(</span><span class="n">train_dl</span><span class="p">,</span> <span class="n">valid_dl</span><span class="p">)</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">opt_func</span><span class="o">=</span><span class="n">SGD</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="n">fashion_mnist_loss</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">batch_accuracy</span><span class="p">)</span>

<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">learning_rate</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>batch_accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.063289</td>
      <td>0.045487</td>
      <td>0.963500</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.044268</td>
      <td>0.042236</td>
      <td>0.964500</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.037112</td>
      <td>0.040228</td>
      <td>0.965500</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.034010</td>
      <td>0.038743</td>
      <td>0.967000</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.032013</td>
      <td>0.038781</td>
      <td>0.966000</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.030633</td>
      <td>0.037635</td>
      <td>0.966500</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.030458</td>
      <td>0.037530</td>
      <td>0.967500</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.029747</td>
      <td>0.036593</td>
      <td>0.967000</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.029511</td>
      <td>0.036479</td>
      <td>0.967500</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.029305</td>
      <td>0.035645</td>
      <td>0.967500</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.028643</td>
      <td>0.035400</td>
      <td>0.966500</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.028562</td>
      <td>0.035477</td>
      <td>0.966500</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>12</td>
      <td>0.028788</td>
      <td>0.035191</td>
      <td>0.968000</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>13</td>
      <td>0.028261</td>
      <td>0.034843</td>
      <td>0.968000</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>14</td>
      <td>0.028172</td>
      <td>0.034883</td>
      <td>0.968500</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So there we have it. We learned how to create a linear learner. Obviously 96.8%
accuracy is pretty good, but it could be better. Next time we're going to add
the final touches to this process by creating a neural network, adding layers of
nonlinearity to ensure our function can fit the complex patterns in our data.</p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="strickvl/ml-blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/fastai/computervision/pytorch/2022/05/14/SGD-fashion-mnist.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>A place to share my technical learnings.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/strickvl" target="_blank" title="strickvl"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/strickvl" target="_blank" title="strickvl"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
