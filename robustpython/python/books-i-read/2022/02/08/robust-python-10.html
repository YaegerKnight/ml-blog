<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>What are invariants and how can they help make your Python classes more robust? | mlops.systems</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="What are invariants and how can they help make your Python classes more robust?" />
<meta name="author" content="Alex Strick van Linschoten" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Chapter 10 covers the last of the user-defined types explored in ‘Robust Python’: classes. We learn what an ‘invariant’ is and how to decide whether to use a data class or a class when rolling your own types." />
<meta property="og:description" content="Chapter 10 covers the last of the user-defined types explored in ‘Robust Python’: classes. We learn what an ‘invariant’ is and how to decide whether to use a data class or a class when rolling your own types." />
<link rel="canonical" href="https://mlops.systems/robustpython/python/books-i-read/2022/02/08/robust-python-10.html" />
<meta property="og:url" content="https://mlops.systems/robustpython/python/books-i-read/2022/02/08/robust-python-10.html" />
<meta property="og:site_name" content="mlops.systems" />
<meta property="og:image" content="https://mlops.systems/images/robust-python/robust-python-cover.jpeg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-02-08T00:00:00-06:00" />
<script type="application/ld+json">
{"datePublished":"2022-02-08T00:00:00-06:00","url":"https://mlops.systems/robustpython/python/books-i-read/2022/02/08/robust-python-10.html","@type":"BlogPosting","dateModified":"2022-02-08T00:00:00-06:00","image":"https://mlops.systems/images/robust-python/robust-python-cover.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlops.systems/robustpython/python/books-i-read/2022/02/08/robust-python-10.html"},"author":{"@type":"Person","name":"Alex Strick van Linschoten"},"headline":"What are invariants and how can they help make your Python classes more robust?","description":"Chapter 10 covers the last of the user-defined types explored in ‘Robust Python’: classes. We learn what an ‘invariant’ is and how to decide whether to use a data class or a class when rolling your own types.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://mlops.systems/feed.xml" title="mlops.systems" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script
  defer
  data-domain="mlops.systems"
  src="https://plausible.io/js/plausible.js"
></script>


<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">mlops.systems</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/drafts/2022-03-25-synthetic-data-results.html">Performance boosts after training with synthetic data</a><a class="page-link" href="/drafts/2022-03-XX-multi-stage-docker-dockerhub.html">Multi-stage Docker builds and pushing to registries</a><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">What are invariants and how can they help make your Python classes more robust?</h1><p class="page-description">Chapter 10 covers the last of the user-defined types explored in 'Robust Python': classes. We learn what an 'invariant' is and how to decide whether to use a data class or a class when rolling your own types.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-02-08T00:00:00-06:00" itemprop="datePublished">
        Feb 8, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Alex Strick van Linschoten</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      7 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#robustpython">robustpython</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#python">python</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#books-i-read">books-i-read</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#what-is-an-invariant">What is an invariant?</a></li>
<li class="toc-entry toc-h2"><a href="#why-code-around-invariants">Why code around invariants?</a></li>
<li class="toc-entry toc-h2"><a href="#invariants-and-class-consumers">Invariants and class consumers</a></li>
<li class="toc-entry toc-h2"><a href="#invariants-and-class-maintainers">Invariants and class maintainers</a></li>
<li class="toc-entry toc-h2"><a href="#encapsulation-and-classes">Encapsulation and classes</a></li>
<li class="toc-entry toc-h2"><a href="#so-what-am-i-supposed-to-use">So what am I supposed to use?</a></li>
</ul><p>We’ve read <a href="https://mlops.systems/robustpython/python/books-i-read/2022/01/30/robust-python-8.html">about enumerations</a> and we’ve read <a href="https://mlops.systems/robustpython/python/books-i-read/2022/02/05/robust-python-9.html">about data classes</a>. Now it’s the turn of classes. Chapter 10 of Patrick Viafore’s excellent book, ‘<a href="https://www.amazon.com/Robust-Python-Patrick-Viafore-ebook-dp-B09982C9FX/dp/B09982C9FX/ref=mt_other?qid=&amp;me=&amp;tag=soumet-20&amp;_encoding=UTF8">Robust Python</a>’, is the last of the user-defined types to be covered. Early on he makes a good point that classes are often taught really early to those new to Python and/or programming, and that maybe the story is a bit more complicated. As I’ve mentioned before, things like enums and data classes are more or less unmentioned in such educational materials and as such I found this book really helped me fill in the conceptual gaps.</p>

<p>First off, for someone who has just learned about data classes, how would you explain what is new or distinct when it comes to classes? They’re slightly different syntactically, with classes requiring you to write a bit more boilerplate. Compare the following:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>

<span class="c1"># data class definition
</span><span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Cat</span><span class="p">:</span>
	<span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
	<span class="n">breed</span><span class="p">:</span> <span class="n">CatBreed</span>
	<span class="n">birth_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">date</span>
	<span class="n">gender</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s">'male'</span><span class="p">,</span> <span class="s">'female'</span><span class="p">]</span>

<span class="c1"># class definition
</span><span class="k">class</span> <span class="nc">Dog</span><span class="p">:</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">breed</span><span class="p">:</span> <span class="n">CatBreed</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">date</span><span class="p">,</span> <span class="n">gender</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s">'male'</span><span class="p">,</span> <span class="s">'female'</span><span class="p">]):</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">breed</span> <span class="o">=</span> <span class="n">breed</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">birth_date</span> <span class="o">=</span> <span class="n">birth_date</span>
		<span class="bp">self</span><span class="p">.</span><span class="n">gender</span> <span class="o">=</span> <span class="n">gender</span>
</code></pre></div></div>

<p>You can note how it seems like the data class version is much more readable and involves less boilerplate to achieve the same effect, and for a simple example like this you’re probably right. The difference, and where classes make sense and shine, is when you have a conceptual grouping or type that includes some notion of invariants.</p>

<h2 id="what-is-an-invariant">
<a class="anchor" href="#what-is-an-invariant" aria-hidden="true"><span class="octicon octicon-link"></span></a>What is an invariant?</h2>

<p>Most of this chapter is about invariants and how they relate to classes, and I’ll admit I had never heard of the concept before reading in this book. An invariant is defined as “a property of an entity that remains unchanged throughout the lifetime of that entity.” You can think of it as some kind of context or a property about that particular type that you need to encode and that won’t change.</p>

<p>The book gives a pizza example (where a <code class="language-plaintext highlighter-rouge">Pizza</code> object could encode that in its list of toppings, the cheese could only be the final topping (i.e. on top) of the pizza). An alternative might be some kind of rule relating to an ID number, where either it must be unique to some kind of specification, or where the ID must conform to some kind of specification.</p>

<p>Even with this rudimentary definition, you can see how there might be some advantages to being able to account for these rules and properties of the object type. (With data classes, you don’t have as much flexibility to specify all these nuances.) So what happens when you’re instantiating a class and you hit one of those scenarios where your contextual rules dictate that something can’t happen? (i.e. someone tries to create a <code class="language-plaintext highlighter-rouge">Pizza</code> object that has cheese as the bottom-layer topping) The book offers up two options:</p>

<ol>
  <li>Throw an exception — this will break you out of the code flow and prevent the object from being constructed</li>
  <li>Do something to make the data fit — you can perform some kind of transformation which sees the cheese ingredient as being forced onto the top layer of the pizza toppings (or whatever is the equivalent for your specific scenario)</li>
</ol>

<p>Note that the kinds of restrictions posed by these invariants are things that can’t fully be captured by the typing system. <a href="https://mlops.systems/categories/#redactionmodel">We’ve covered type hints</a> and how they can help make your code more robust, but types don’t help much when it comes to the order of a list, for example.</p>

<h2 id="why-code-around-invariants">
<a class="anchor" href="#why-code-around-invariants" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why code around invariants?</h2>

<p>So why go to all of this trouble in the first place? How does it benefit to code with the invariants in mind? To start with, it’ll probably help you think through edge cases and exceptions that you could do well to be wary of. The invariants alert you to the fact that arguments passed into functions and methods will not always be in the form that you would ideally like. (As a side note, this might also encourage you to add unit tests.)</p>

<p>It will help you keep the code that handles the invariants together instead of mixing it in with the code that instantiates the objects. In general, it will enhance your ability to reason about the code and the concepts that your code reflects. This is important not only for the implementation in code, but for how you think about any particular part and how it relates to the rest of your code base.</p>

<p>The goal for all of this: fewer bugs and a more robust system. Yes, it takes a bit more effort to think whether there are implicit or explicit invariants, but doing so makes your code and your system more reliable. In Viafore’s words:</p>

<blockquote>
  <p>“You’re making an easier API for people to think about, and you reduce the risk of people using your objects incorrectly. […] You never want someone to be surprised when using your code.” (p. 141)</p>
</blockquote>

<h2 id="invariants-and-class-consumers">
<a class="anchor" href="#invariants-and-class-consumers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Invariants and class consumers</h2>

<p>The rest of the chapter is about the implementation consequences of thinking about classes in this invariants-first way. For consumers of the class, how should you ensure that the invariants handled are clear? Aside from the implementation itself (in the constructor), docstrings and code comments are suggested as a means to this end. Of course, <code class="language-plaintext highlighter-rouge">README</code> files and documentation in general can serve the same purpose, but it’s best if the context and information about invariants is as close to the code as possible.</p>

<h2 id="invariants-and-class-maintainers">
<a class="anchor" href="#invariants-and-class-maintainers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Invariants and class maintainers</h2>

<p>For (future) maintainers of the class, unit tests are the way to go. Make sure that the relevant scenarios and invariants are covered by testing code and you will have extra confidence that your object instantiation really does do what you intend. Your code should already be doing the checking for invariants on the instantiation side, but unit tests are a way of ensuring that this is actually the case (and also that these invariants remain covered as the code base continues to evolve.</p>

<p>(The book offers one way of doing such tests for invariants with <code class="language-plaintext highlighter-rouge">contextlib.contextmanager</code> on page 145.)</p>

<h2 id="encapsulation-and-classes">
<a class="anchor" href="#encapsulation-and-classes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Encapsulation and classes</h2>

<p>As the final chunk of the chapter, we learn about private, protected and public access to the properties and methods of a class, and how they relate to the maintenance of invariants.</p>

<p>This is an important part of the story. As users interface with your class and API, encapsulation is a way to ensure that they update and interact with the these properties in a way that is under your control. For example, even if at instantiation you enforce the <code class="language-plaintext highlighter-rouge">Pizza</code> object having cheese as the top-layer topping, what do we have in place to ensure that the user doesn’t just amend the <code class="language-plaintext highlighter-rouge">toppings</code> property such that the cheese is the bottom-layer topping (i.e. AFTER instantiation)? Encapsulation — having an entity hide or restrict access to certain properties and actions — is how you handle that.</p>

<p>The book goes into a fair amount of detail on the uses of these different levels of access, and introduces the idea of ‘accessors’ and ‘mutators’ as an alternative to the more commonly-used ‘getters’ and ‘setters’.</p>

<p>Remember, “you use invariants to allow users to reason about your objects and reduce cognitive load.” (p. 151)</p>

<h2 id="so-what-am-i-supposed-to-use">
<a class="anchor" href="#so-what-am-i-supposed-to-use" aria-hidden="true"><span class="octicon octicon-link"></span></a>So what am I supposed to use?</h2>

<p><img src="/images/robust-python-10/which-abstraction.png" alt="" title="A super helpful diagram from the book helping you choose which abstraction to pick."></p>

<p>The end of the chapter offers this really helpful flowchart diagram which summarises the choices that we’ve covered during the previous three chapters. I really want to highlight that this chapter helped me think about classes in a way I hadn’t, despite having been through courses, having read numerous articles and of course coded in this class-oriented fashion for several years.</p>

<p>The next few chapters continue onwards by thinking about how to design your interfaces such that they make sense for your users and allow your code base to grow with as few headaches as possible.</p>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="strickvl/ml-blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/robustpython/python/books-i-read/2022/02/08/robust-python-10.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>A place to share my technical learnings.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/strickvl" target="_blank" title="strickvl"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/strickvl" target="_blank" title="strickvl"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
